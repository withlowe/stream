<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stream</title>
  <meta name="description" content="A personal stream." />
  <link rel="alternate" type="application/rss+xml" title="Stream" href="/feed.xml" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <div class="header-inner">
    <a class="site-name" href="/" id="site-name">Stream</a>
    <div class="header-right">
      <button class="rss-link" onclick="copyFeed(this)">Subscribe</button>
    </div>
  </div>
</header>

<!-- Tag filter bar — hidden until a tag is active -->
<div class="tag-bar" id="tag-bar" style="display:none">
  <div class="tag-bar-inner">
    <span class="tag-bar-label">Tagged:</span>
    <span class="tag-bar-name" id="tag-bar-name"></span>
    <button class="tag-bar-clear" onclick="clearTag()">✕ Show all</button>
  </div>
</div>

<main>
  <div class="feed" id="feed"></div>
  <div class="feed-empty" id="empty">No posts yet.</div>
  <div class="loading-bar" id="loader"><span></span><span></span><span></span></div>
  <div class="load-trigger" id="trigger"></div>
  <div class="end-line" id="end">—</div>
</main>

<script>
  const PAGE_SIZE = 10;
  let allPosts = [];
  let filteredPosts = [];
  let activeTag = null;
  let page = 0;
  let loading = false;
  let done = false;

  function formatDate(iso) {
    const d = new Date(iso);
    const now = new Date();
    const diff = (now - d) / 1000;
    if (diff < 60)     return 'just now';
    if (diff < 3600)   return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400)  return Math.floor(diff / 3600) + 'h ago';
    if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
    return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })
      + ' · ' + d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
  }

  function escapeHTML(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function formatBody(str) {
    return str.split(/\n\n+/)
      .map(p => '<p>' + escapeHTML(p).replace(/\n/g,'<br>') + '</p>')
      .join('');
  }

  function makePost(post) {
    const el = document.createElement('article');
    const imageOnly = !post.body && post.image;
    const featured  = post.featured === true;
    let cls = 'post';
    if (imageOnly) cls += ' image-only';
    if (featured)  cls += ' featured';
    el.className = cls;

    const tags = Array.isArray(post.tags) ? post.tags : [];
    const tagsInline = tags.map(t =>
      '<button class="post-tag' + (t === activeTag ? ' active' : '') + '" onclick="filterTag(\'' + escapeHTML(t) + '\')">' + escapeHTML(t) + '</button>'
    ).join('');

    const timeEl  = '<div class="post-meta"><time class="post-time" datetime="' + post.date + '">' + formatDate(post.date) + '</time>' + (tagsInline ? '<span class="post-tags-inline">' + tagsInline + '</span>' : '') + '</div>';
    const titleEl = post.title ? '<div class="post-title">' + escapeHTML(post.title) + '</div>' : '';
    const bodyEl  = post.body  ? '<div class="post-body">'  + formatBody(post.body)  + '</div>' : '';
    const imgPath = post.image ? (post.image.startsWith('http') ? post.image : '/' + post.image) : null;
    const imgEl   = imgPath    ? '<div class="post-image loading"><img data-src="' + imgPath + '" alt=""/></div>' : '';

    el.innerHTML = timeEl + titleEl + bodyEl + imgEl;

    const img = el.querySelector('img[data-src]');
    if (img) imgObserver.observe(img);
    return el;
  }

  function filterTag(tag) {
    if (activeTag === tag) { clearTag(); return; }
    activeTag = tag;
    document.getElementById('tag-bar').style.display = 'block';
    document.getElementById('tag-bar-name').textContent = tag;
    filteredPosts = allPosts.filter(p => Array.isArray(p.tags) && p.tags.includes(tag));
    resetFeed();
  }

  function clearTag() {
    activeTag = null;
    document.getElementById('tag-bar').style.display = 'none';
    filteredPosts = allPosts;
    resetFeed();
  }

  function resetFeed() {
    page = 0; loading = false; done = false;
    document.getElementById('feed').innerHTML = '';
    document.getElementById('end').style.display = 'none';
    document.getElementById('empty').style.display = 'none';
    if (filteredPosts.length === 0) {
      document.getElementById('empty').textContent = activeTag ? 'No posts tagged "' + activeTag + '".' : 'No posts yet.';
      document.getElementById('empty').style.display = 'block';
      return;
    }
    renderPage();
  }

  function renderPage() {
    if (loading || done) return;
    loading = true;
    document.getElementById('loader').classList.add('active');
    const slice = filteredPosts.slice(page * PAGE_SIZE, (page + 1) * PAGE_SIZE);
    setTimeout(function() {
      const feed = document.getElementById('feed');
      slice.forEach(function(post, i) {
        const el = makePost(post);
        feed.appendChild(el);
        setTimeout(function() { revealObserver.observe(el); }, i * 50);
      });
      page++;
      loading = false;
      document.getElementById('loader').classList.remove('active');
      if (page * PAGE_SIZE >= filteredPosts.length) {
        done = true;
        document.getElementById('end').style.display = 'block';
      }
    }, 200);
  }

  const revealObserver = new IntersectionObserver(function(entries) {
    entries.forEach(function(e) {
      if (e.isIntersecting) { e.target.classList.add('visible'); revealObserver.unobserve(e.target); }
    });
  }, { threshold: 0.04 });

  const imgObserver = new IntersectionObserver(function(entries) {
    entries.forEach(function(e) {
      if (e.isIntersecting) {
        const img = e.target;
        img.src = img.dataset.src;
        img.onload = function() {
          img.classList.add('loaded');
          img.closest('.post-image').classList.remove('loading');
        };
        imgObserver.unobserve(img);
      }
    });
  }, { rootMargin: '300px' });

  const triggerObserver = new IntersectionObserver(function(entries) {
    if (entries[0].isIntersecting) renderPage();
  }, { rootMargin: '400px' });

  function copyFeed(btn) {
    const url = window.location.origin + '/feed.xml';
    navigator.clipboard.writeText(url).then(function() {
      btn.textContent = 'Copied!';
      setTimeout(function() { btn.textContent = 'Subscribe'; }, 2000);
    }).catch(function() {
      // fallback: select a temporary input
      const inp = document.createElement('input');
      inp.value = url;
      document.body.appendChild(inp);
      inp.select();
      document.execCommand('copy');
      document.body.removeChild(inp);
      btn.textContent = 'Copied!';
      setTimeout(function() { btn.textContent = 'Subscribe'; }, 2000);
    });
  }

  async function init() {
    try {
      const cfg = await fetch('config.json?v=' + Date.now()).then(r => r.json());
      if (cfg.siteName) {
        document.getElementById('site-name').textContent = cfg.siteName;
        document.title = cfg.siteName;
      }
    } catch(e) {}

    try {
      const res = await fetch('posts.json?v=' + Date.now());
      allPosts = await res.json();
      allPosts.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
      filteredPosts = allPosts;
      if (allPosts.length === 0) {
        document.getElementById('empty').style.display = 'block';
        return;
      }
      triggerObserver.observe(document.getElementById('trigger'));
      renderPage();
    } catch(err) {
      document.getElementById('empty').textContent = 'Failed to load posts.';
      document.getElementById('empty').style.display = 'block';
    }
  }

  init();
</script>
</body>
</html>
